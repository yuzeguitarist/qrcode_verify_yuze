<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ä¸­å¿ƒ - ä¹¦ç±éªŒè¯ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-activated {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            min-width: 200px;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .charts-section {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>ğŸ“Š ç®¡ç†ä¸­å¿ƒ</h1>
            <p class="subtitle">ä¹¦ç±éªŒè¯ç³»ç»Ÿæ•°æ®ç»Ÿè®¡</p>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCodes">0</div>
                <div class="stat-label">æ€»éªŒè¯ç æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activatedCodes">0</div>
                <div class="stat-label">å·²æ¿€æ´»æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingCodes">0</div>
                <div class="stat-label">å¾…æ¿€æ´»æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activationRate">0%</div>
                <div class="stat-label">æ¿€æ´»ç‡</div>
            </div>
        </div>

        <!-- ç­›é€‰å’Œå¯¼å‡º -->
        <div class="filter-section">
            <input type="text" id="searchInput" class="filter-input" placeholder="æœç´¢éªŒè¯ç ...">
            <select id="statusFilter" class="filter-input">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="activated">å·²æ¿€æ´»</option>
                <option value="pending">å¾…æ¿€æ´»</option>
            </select>
            <button class="export-btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            <button class="export-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="data-table">
            <h3>éªŒè¯ç è¯¦æƒ…</h3>
            <table id="codesTable">
                <thead>
                    <tr>
                        <th>éªŒè¯ç </th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ¿€æ´»æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="codesTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
                </tbody>
            </table>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-section">
            <h3>æ¿€æ´»è¶‹åŠ¿</h3>
            <div class="chart-container" id="chartContainer">
                <canvas id="activationChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        class AdminPanel {
            constructor() {
                this.codes = [];
                this.filteredCodes = [];
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.updateStats();
                this.renderTable();
            }

            async loadData() {
                try {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                    const codesData = localStorage.getItem('codes');
                    const activationsData = localStorage.getItem('activations');
                    
                    if (codesData) {
                        this.codes = JSON.parse(codesData);
                    } else {
                        // ç”Ÿæˆä¸€äº›ç¤ºä¾‹æ•°æ®
                        this.codes = this.generateSampleData();
                        localStorage.setItem('codes', JSON.stringify(this.codes));
                    }

                    // åˆå¹¶æ¿€æ´»æ•°æ®
                    if (activationsData) {
                        const activations = JSON.parse(activationsData);
                        this.mergeActivationData(activations);
                    }

                    this.filteredCodes = [...this.codes];
                    
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    this.codes = this.generateSampleData();
                    this.filteredCodes = [...this.codes];
                }
            }

            generateSampleData() {
                const sampleCodes = [];
                const statuses = ['activated', 'pending'];
                
                for (let i = 0; i < 20; i++) {
                    const code = this.generateRandomCode();
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    const createdDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                    
                    sampleCodes.push({
                        code: code,
                        created_date: createdDate.toISOString(),
                        activated: status === 'activated',
                        activation_date: status === 'activated' ? 
                            new Date(createdDate.getTime() + Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString() : 
                            null
                    });
                }
                
                return sampleCodes;
            }

            generateRandomCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 12; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            }

            mergeActivationData(activations) {
                activations.forEach(activation => {
                    const code = this.codes.find(c => c.code === activation.code);
                    if (code && !code.activated) {
                        code.activated = true;
                        code.activation_date = activation.activation_time;
                    }
                });
            }

            setupEventListeners() {
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterCodes();
                });

                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filterCodes();
                });
            }

            filterCodes() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;

                this.filteredCodes = this.codes.filter(code => {
                    const matchesSearch = code.code.toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || 
                        (statusFilter === 'activated' && code.activated) ||
                        (statusFilter === 'pending' && !code.activated);
                    
                    return matchesSearch && matchesStatus;
                });

                this.renderTable();
            }

            updateStats() {
                const total = this.codes.length;
                const activated = this.codes.filter(c => c.activated).length;
                const pending = total - activated;
                const rate = total > 0 ? Math.round((activated / total) * 100) : 0;

                document.getElementById('totalCodes').textContent = total;
                document.getElementById('activatedCodes').textContent = activated;
                document.getElementById('pendingCodes').textContent = pending;
                document.getElementById('activationRate').textContent = rate + '%';
            }

            renderTable() {
                const tbody = document.getElementById('codesTableBody');
                tbody.innerHTML = '';

                this.filteredCodes.forEach(code => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${code.code}</strong></td>
                        <td>${new Date(code.created_date).toLocaleString('zh-CN')}</td>
                        <td>
                            <span class="status-badge ${code.activated ? 'status-activated' : 'status-pending'}">
                                ${code.activated ? 'å·²æ¿€æ´»' : 'å¾…æ¿€æ´»'}
                            </span>
                        </td>
                        <td>${code.activation_date ? new Date(code.activation_date).toLocaleString('zh-CN') : '-'}</td>
                        <td>
                            <button onclick="admin.viewDetails('${code.code}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            viewDetails(code) {
                const codeData = this.codes.find(c => c.code === code);
                if (codeData) {
                    const details = `
éªŒè¯ç ï¼š${codeData.code}
åˆ›å»ºæ—¶é—´ï¼š${new Date(codeData.created_date).toLocaleString('zh-CN')}
çŠ¶æ€ï¼š${codeData.activated ? 'å·²æ¿€æ´»' : 'å¾…æ¿€æ´»'}
æ¿€æ´»æ—¶é—´ï¼š${codeData.activation_date ? new Date(codeData.activation_date).toLocaleString('zh-CN') : 'æœªæ¿€æ´»'}
                    `;
                    alert(details);
                }
            }

            exportData() {
                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `verification_codes_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            generateCSV() {
                const headers = ['éªŒè¯ç ', 'åˆ›å»ºæ—¶é—´', 'çŠ¶æ€', 'æ¿€æ´»æ—¶é—´'];
                const rows = this.codes.map(code => [
                    code.code,
                    new Date(code.created_date).toLocaleString('zh-CN'),
                    code.activated ? 'å·²æ¿€æ´»' : 'å¾…æ¿€æ´»',
                    code.activation_date ? new Date(code.activation_date).toLocaleString('zh-CN') : 'æœªæ¿€æ´»'
                ]);

                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            async refreshData() {
                await this.loadData();
                this.updateStats();
                this.renderTable();
                alert('æ•°æ®å·²åˆ·æ–°');
            }
        }

        // å…¨å±€å˜é‡ï¼Œä¾›æŒ‰é’®è°ƒç”¨
        let admin;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            admin = new AdminPanel();
        });

        // å…¨å±€å‡½æ•°
        function exportData() {
            admin.exportData();
        }

        function refreshData() {
            admin.refreshData();
        }
    </script>
</body>
</html> 