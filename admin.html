<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 乐谱验证系统</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <!-- 登录界面 -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>🎵 管理后台</h1>
            <p class="subtitle">乐谱验证系统</p>
            
            <div class="login-form">
                <div class="input-group">
                    <label>邮箱</label>
                    <input type="email" id="loginEmail" placeholder="请输入管理员邮箱">
                </div>
                <div class="input-group">
                    <label>密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">登录</button>
                <p class="error-message hidden" id="loginError"></p>
            </div>
            
            <div class="footer">
                <p><small>乐谱验证系统 v3.0 - Yuze Pan</small></p>
            </div>
        </div>
    </div>

    <!-- 管理界面 -->
    <div class="admin-container hidden" id="adminContainer">
        <!-- 顶部导航 -->
        <div class="header">
            <div class="header-left">
                <h1>🎵 管理后台</h1>
            </div>
            <div class="header-right">
                <span id="adminEmail"></span>
                <button class="btn btn-secondary" onclick="handleLogout()">退出</button>
            </div>
        </div>

        <!-- 导航标签 -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">仪表板</button>
            <button class="tab" onclick="switchTab('codes')">验证码管理</button>
            <button class="tab" onclick="switchTab('logs')">验证日志</button>
            <button class="tab" onclick="switchTab('stats')">统计分析</button>
        </div>

        <!-- 仪表板 -->
        <div class="content" id="dashboardContent">
            <h2>系统概览</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">总验证码数</div>
                    <div class="stat-value" id="totalCodes">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">已激活</div>
                    <div class="stat-value" id="activatedCodes">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">未激活</div>
                    <div class="stat-value" id="pendingCodes">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">激活率</div>
                    <div class="stat-value" id="activationRate">-</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">今日验证次数</div>
                    <div class="stat-value" id="todayVerifications">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日新增激活</div>
                    <div class="stat-value" id="todayActivations">-</div>
                </div>
            </div>

            <div class="action-section">
                <h3>快速操作</h3>
                <button class="btn btn-primary" onclick="refreshStats()">刷新统计</button>
                <button class="btn btn-secondary" onclick="switchTab('codes')">管理验证码</button>
            </div>
        </div>

        <!-- 验证码管理 -->
        <div class="content hidden" id="codesContent">
            <h2>验证码管理</h2>
            
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchCode" placeholder="搜索验证码...">
                    <button class="btn btn-primary" onclick="searchCodes()">搜索</button>
                </div>
                <div class="filter-box">
                    <select id="filterStatus" onchange="filterCodes()">
                        <option value="all">全部</option>
                        <option value="activated">已激活</option>
                        <option value="pending">未激活</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportCodes()">导出CSV</button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>验证码</th>
                            <th>创建时间</th>
                            <th>状态</th>
                            <th>激活时间</th>
                            <th>验证次数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="codesTableBody">
                        <tr>
                            <td colspan="6" class="loading">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="codesPagination">
                <button class="btn btn-secondary" onclick="prevPage()">上一页</button>
                <span id="pageInfo">第 1 页</span>
                <button class="btn btn-secondary" onclick="nextPage()">下一页</button>
            </div>
        </div>

        <!-- 验证日志 -->
        <div class="content hidden" id="logsContent">
            <h2>验证日志</h2>
            
            <div class="toolbar">
                <div class="filter-box">
                    <select id="filterResult" onchange="filterLogs()">
                        <option value="all">全部</option>
                        <option value="success">成功</option>
                        <option value="invalid_code">失败</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshLogs()">刷新</button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>验证码</th>
                            <th>验证时间</th>
                            <th>结果</th>
                            <th>IP地址</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr>
                            <td colspan="4" class="loading">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="logsPagination">
                <button class="btn btn-secondary" onclick="prevLogPage()">上一页</button>
                <span id="logPageInfo">第 1 页</span>
                <button class="btn btn-secondary" onclick="nextLogPage()">下一页</button>
            </div>
        </div>

        <!-- 统计分析 -->
        <div class="content hidden" id="statsContent">
            <h2>统计分析</h2>
            
            <div class="stats-section">
                <h3>每日统计（最近30天）</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>总验证码数</th>
                                <th>已激活数</th>
                                <th>今日验证次数</th>
                                <th>今日新增激活</th>
                            </tr>
                        </thead>
                        <tbody id="dailyStatsBody">
                            <tr>
                                <td colspan="5" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 管理后台脚本 -->
    <script src="admin-script.js"></script>
</body>
</html>
